name: Build & test qemu
on: push
jobs:
  build:
    name: Builds all images
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Build base image
      run: >
        DOCKER_BUILDKIT=1 docker build .
        --build-arg QEMU_VERSION=v4.1.0
        --file      Dockerfile
        --target    builder

    - name: Build :enable
      run: >
        DOCKER_BUILDKIT=1 docker build .
        --build-arg QEMU_VERSION=v4.1.0
        --tag       ${GITHUB_REPOSITORY,,}:enable
        --file      Dockerfile
        --target    enable

    - name: Build :<single-arch>
      run: |
        for arch in arm aarch64 riscv32 riscv64; do
          DOCKER_BUILDKIT=1 docker build . \
            --build-arg QEMU_VERSION=v4.1.0 \
            --build-arg ARCH=${arch} \
            --tag       ${GITHUB_REPOSITORY,,}:${arch} \
            --file      Dockerfile \
            --target    single
        done

    - name: Build :latest
      run: >
        DOCKER_BUILDKIT=1 docker build .
        --build-arg QEMU_VERSION=v4.1.0
        --tag       ${GITHUB_REPOSITORY,,}:latest
        --file      Dockerfile
        --target    latest

    - name: List all
      run: docker images ${GITHUB_REPOSITORY,,}

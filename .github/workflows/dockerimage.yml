name: Build & test qemu
on: push
jobs:
  build:
    name: Builds all images
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Build base image
      run: >
        DOCKER_BUILDKIT=1 docker build .
        --build-arg QEMU_VERSION=v4.1.0
        --file      Dockerfile
        --target    builder

    - name: Build :enable
      run: >
        DOCKER_BUILDKIT=1 docker build .
        --build-arg QEMU_VERSION=v4.1.0
        --tag       ${GITHUB_REPOSITORY,,}:enable
        --file      Dockerfile
        --target    enable

    - name: Build :<single-arch>
      run: |
        for arch in arm aarch64 riscv32 riscv64; do
          DOCKER_BUILDKIT=1 docker build . \
            --build-arg QEMU_VERSION=v4.1.0 \
            --build-arg ARCH=${arch} \
            --tag       ${GITHUB_REPOSITORY,,}:${arch} \
            --file      Dockerfile \
            --target    single
        done

    - name: Build :latest
      run: >
        DOCKER_BUILDKIT=1 docker build .
        --build-arg QEMU_VERSION=v4.1.0
        --tag       ${GITHUB_REPOSITORY,,}:latest
        --file      Dockerfile
        --target    latest

    - name: List all
      run: docker images ${GITHUB_REPOSITORY,,}

#  build-singles:
#    name: "Builds single-arch: ${{ matrix.arch }}"
#    runs-on: ubuntu-latest
#    needs: build-enable
#    strategy:
#      matrix:
#        arch: [arm, aarch64, riscv32, riscv64]
#    steps:
#    - uses: actions/checkout@v1
#    - run: DOCKER_BUILDKIT=1 docker build . --tag meedamian/simple-qemu:${{ matrix.arch }} --target single --build-arg QEMU_VERSION=v4.1.0 --build-arg ARCH=${{ matrix.arch }} --file Dockerfile
#
#  build-latest:
#    name: "Builds the one with them all"
#    runs-on: ubuntu-latest
#    needs: build-enable
#    steps:
#    - uses: actions/checkout@v1
#    - name: Build meedamian/simple-qemu:latest
#      run: DOCKER_BUILDKIT=1 docker build . --tag meedamian/simple-qemu:latest --target latest --build-arg QEMU_VERSION=v4.1.0 --file Dockerfile
#

name: Build & deploy qemu

on: push

jobs:
  build:
    name: Builds all images
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - name: Remove fluff from built-architectures.txt
      run: sed -i  -e 's/#.*$//'  -e '/^$/d'  ./built-architectures.txt

    - name: Build base image
      run: >
        DOCKER_BUILDKIT=1 docker build .
        --build-arg QEMU_VERSION=v4.1.0
        --tag       midstate
        --file      Dockerfile
        --target    builder

    - name: Build :enable
      run: >
        DOCKER_BUILDKIT=1 docker build .
        --build-arg QEMU_VERSION=v4.1.0
        --tag       ${GITHUB_REPOSITORY,,}:enable
        --file      Dockerfile
        --target    enable

    - name: Build :<single-arch>
      run: |
        for arch in $(cat built-architectures.txt); do
          echo "${arch}"
          DOCKER_BUILDKIT=1 docker build . \
            --build-arg QEMU_VERSION=v4.1.0 \
            --build-arg ARCH=${arch} \
            --tag       ${GITHUB_REPOSITORY,,}:${arch} \
            --file      Dockerfile \
            --target    single
        done

    - name: Build :latest
      run: >
        DOCKER_BUILDKIT=1 docker build .
        --build-arg QEMU_VERSION=v4.1.0
        --tag       ${GITHUB_REPOSITORY,,}:latest
        --file      Dockerfile
        --target    latest

    - name: List all
      run: docker images ${GITHUB_REPOSITORY,,}

    - name: Save all images
      run: |
        mkdir -p containers/
        for container in $(docker images ${GITHUB_REPOSITORY,,} --format "{{.Repository}}:{{.Tag}}"); do
          FILENAME="$(echo "${container}" | tr /: -)"
          docker save "${container}" | gzip > "containers/${FILENAME}.tgz"
        done

#        mkdir -p qqq/
#        docker images ${GITHUB_REPOSITORY,,} --format "{{.Repository}}:{{.Tag}}" | xargs -I % docker save % | gzip > qqq/%.tgz

    - name: Upload containers
      uses: actions/upload-artifact@v1.0.0
      with:
        name: containers
        path: containers/

    - name: Extract all built binaries from image
      run: |
        ID=$(docker create midstate)
        docker cp  "${ID}:/binaries/"  binaries/
        docker rm "${ID}"

    - name: Upload binaries
      uses: actions/upload-artifact@v1.0.0
      with:
        name: binaries
        path: binaries/


#  docker-hub:
#    name: Performs meta stuff
#    runs-on: ubuntu-latest
#    needs: build
#    steps:
##    - uses: actions/checkout@v1
#    - name: Sync README.md and description with Docker Hub
#      uses: meeDamian/sync-readme@v1.0.5
#      with:
#        pass: ${{ secrets.DOCKER_PASS }}
#        description: true
